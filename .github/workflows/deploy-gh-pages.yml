name: deploy gh pages
concurrency: staging
on:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

defaults:
  run:
    shell: bash

jobs:
  build:
    if: |
    runs-on: ubuntu-22.04
    environment: staging
    steps:
      - name: Checkout project with submodules
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: '0.89.4'
          extended: true

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '14.17.5'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            themes/docsy/package-lock.json

      - name: Install project dependencies
        run: |
          npm ci

      - name: Install docsy dependencies
        run: |
          cd themes/docsy
          npm ci

      - name: Generate static site with hugo
        run: |
          hugo --minify --baseURL https://wes-williams.github.io/lexical-cloud-docs-hugo/
  
      - name: Preview changes to public submodule
        id: preview-public-changes 
        run: |
          cd public
          git add .
          git status
          echo "diff-count=$(git status --porcelain | wc -l)" >> $GITHUB_OUTPUT
          echo "main-diff-count=$(git diff --name-only main | wc -l)" >> $GITHUB_OUTPUT

      - name: Stage static site for preview
        run: |
          touch public/.nojekyll
          echo '' > public/CNAME
        env:
          PR_NUM: ${{ github.event.pull_request.number }}
          RUN_NUM: ${{ github.run_number }}

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v3

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v1
        with:
          path: ./public

  deploy:
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2
